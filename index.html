<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gráfico (amCharts 5) — Velas com backend PHP</title>

  <!-- amCharts 5 (CDN) -->
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #0f1217; /* dark */
      color: #eaeef5;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    header {
      padding: 10px 14px;
      border-bottom: 1px solid #1b212c;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    header h1 {
      font-size: 16px;
      margin: 0;
      font-weight: 600;
    }
    .toolbar {
      margin-left: auto;
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .toolbar label { opacity: .8; }
    main { height: calc(100% - 52px); }
    #chartdiv { width: 100%; height: 100%; }
    .badge {
      background:#1b212c;border-radius:6px;padding:4px 8px;font-size:12px;opacity:.9
    }
    select, button {
      background: #151a23; color:#eaeef5; border:1px solid #2a3444; border-radius:8px;
      padding:6px 10px;
    }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <header>
    <h1>amCharts 5 — Candlestick</h1>
    <span class="badge">Fonte: <code>data.php</code> (simulador)</span>
    <div class="toolbar">
      <label>Par:</label>
      <select id="symbol">
        <option value="BTCUSDT" selected>BTCUSDT</option>
        <option value="ETHUSDT">ETHUSDT</option>
        <option value="SOLUSDT">SOLUSDT</option>
      </select>

      <label>Intervalo:</label>
      <select id="interval">
        <option value="1">1s</option>
        <option value="2">2s</option>
        <option value="5">5s</option>
        <option value="10">10s</option>
        <option value="60">1m</option>
      </select>

      <label>Histórico:</label>
      <select id="limit">
        <option value="200">200 velas</option>
        <option value="500" selected>500 velas</option>
        <option value="1000">1000 velas</option>
      </select>

      <button id="reload">Recarregar</button>
    </div>
  </header>

  <main>
    <div id="chartdiv"></div>
  </main>

  <script>
    // ======= Config =======
    const API_URL = 'data.php'; // mesmo domínio
    let pollTimer = null;

    // ======= UI =======
    const elSymbol   = document.getElementById('symbol');
    const elInterval = document.getElementById('interval');
    const elLimit    = document.getElementById('limit');
    const elReload   = document.getElementById('reload');

    // ======= amCharts 5 =======
    let root, chart, xAxis, yAxis, series;

    function msPerInterval(intervalSec) {
      return Number(intervalSec) * 1000;
    }

    function initChart(intervalSec) {
      // Destroi instâncias anteriores (hot reload)
      if (root) {
        root.dispose();
        root = null;
      }

      root = am5.Root.new("chartdiv");
      root.setThemes([ am5themes_Animated.new(root) ]);

      chart = root.container.children.push(am5xy.XYChart.new(root, {
        panX: true, panY: false, wheelX: "panX", wheelY: "zoomX"
      }));

      // Eixo X por tempo (baseInterval sincronizado ao backend)
      xAxis = chart.xAxes.push(am5xy.DateAxis.new(root, {
        baseInterval: { timeUnit: "second", count: Number(intervalSec) },
        renderer: am5xy.AxisRendererX.new(root, {}),
        tooltip: am5.Tooltip.new(root, {})
      }));

      // Eixo Y (preço)
      yAxis = chart.yAxes.push(am5xy.ValueAxis.new(root, {
        renderer: am5xy.AxisRendererY.new(root, {}),
        tooltip: am5.Tooltip.new(root, {})
      }));

      // Série de velas
      series = chart.series.push(am5xy.CandlestickSeries.new(root, {
        name: "Preço",
        xAxis, yAxis,
        openValueYField: "o",
        highValueYField: "h",
        lowValueYField: "l",
        valueYField: "c",
        valueXField: "t" // timestamp (ms)
      }));

      // Cursor
      chart.set("cursor", am5xy.XYCursor.new(root, {
        xAxis,
        behavior: "zoomX"
      }));
    }

    async function fetchJSON(url) {
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    async function loadHistory(symbol, intervalSec, limit) {
      const url = `${API_URL}?action=history&symbol=${encodeURIComponent(symbol)}&interval=${intervalSec}&limit=${limit}`;
      return fetchJSON(url);
    }

    async function fetchNext(symbol, intervalSec) {
      const url = `${API_URL}?action=next&symbol=${encodeURIComponent(symbol)}&interval=${intervalSec}`;
      return fetchJSON(url);
    }

    function startPolling(symbol, intervalSec) {
      stopPolling();
      // Alinha o primeiro fetch ao "fechamento" da próxima vela
      const delay = msPerInterval(intervalSec);
      pollTimer = setTimeout(async function tick() {
        try {
          const candle = await fetchNext(symbol, intervalSec);
          applyCandle(candle);
        } catch (e) {
          console.error("Polling error:", e);
        } finally {
          pollTimer = setTimeout(tick, delay); // agenda próximo
        }
      }, delay);
    }

    function stopPolling() {
      if (pollTimer) {
        clearTimeout(pollTimer);
        pollTimer = null;
      }
    }

    function applyHistory(data) {
      // data = [{t,o,h,l,c}, ...] timestamps em ms (ordenado)
      series.data.setAll(data);
      // dá um zoom para ver melhor o histórico recente
      const last = data.at(-1)?.t ?? Date.now();
      const span = Math.max(msPerInterval(elInterval.value) * 250, 60_000);
      xAxis.zoomToDates(new Date(last - span), new Date(last));
    }

    function applyCandle(c) {
      if (!c || typeof c.t !== "number") return;
      const items = series.dataItems;
      const last = items[items.length - 1];

      if (last && last.get("valueX") === c.t) {
        // Atualiza a vela corrente (durante formação)
        last.setAll({
          openValueY: c.o,
          highValueY: c.h,
          lowValueY:  c.l,
          valueY:     c.c
        });
      } else {
        // Nova vela “fechada”
        series.data.push(c);
        // Mantém um buffer enxuto (evita usar muita memória)
        if (series.data.length > 5000) {
          series.data.removeIndex(0);
        }
      }
    }

    async function boot() {
      const symbol = elSymbol.value;
      const intervalSec = Number(elInterval.value);
      const limit = Number(elLimit.value);

      initChart(intervalSec);

      try {
        const hist = await loadHistory(symbol, intervalSec, limit);
        applyHistory(hist);
      } catch (e) {
        console.error("Falha ao carregar histórico:", e);
      }

      startPolling(symbol, intervalSec);
    }

    // UI handlers
    elReload.addEventListener('click', boot);
    elSymbol.addEventListener('change', boot);
    elInterval.addEventListener('change', boot);
    elLimit.addEventListener('change', boot);

    // Inicializa
    am5.ready(boot);
  </script>
</body>
</html>
